// --------------------------------------------------------------
// Copyright (C)
// Universitat Politecnica de Catalunya (UPC) - Barcelona - Spain
// --------------------------------------------------------------

//! 
//! \file detector.test
//!
//! Tests for Detector class
//!
#include <boost/filesystem.hpp>
#include <imageplus/semantic/detector.hpp>

#ifdef USE_XML

BOOST_AUTO_TEST_SUITE ( Semantic_Detector_Suite );

using namespace imageplus;
using namespace imageplus::semantic;
using namespace std;

BOOST_AUTO_TEST_CASE( detector_outputdir_test )
{
    // Models file
	boost::filesystem::path models_file = string(TEST_DATA_PATH_R);
	models_file /= "semantic";
	models_file /= "6_models";
	models_file /= "image";
	models_file /= "F1_publi";
	models_file /= "index.xml";

	// Output directory
	boost::filesystem::path output_dir = string(TEST_DATA_PATH_W);
	output_dir /= "semantic";
	output_dir /= "detector";
	boost::filesystem::create_directories(output_dir);

	// Check detector instantiation checks that the output directory exists
    BOOST_CHECK_THROW(Detector(models_file.string(), "/non/existent/directory"), ImagePlusError);

    // Check detector instantiation does not throw any exception
    BOOST_CHECK_NO_THROW(Detector(models_file.string(), output_dir.string()));
}

BOOST_AUTO_TEST_CASE( detector_detect_test )
{
    // Models file
	boost::filesystem::path models_file = string(TEST_DATA_PATH_R);
	models_file /= "semantic";
	models_file /= "6_models";
	models_file /= "image";
	models_file /= "F1_publi";
	models_file /= "index.xml";

	// Output directory
	boost::filesystem::path output_dir = string(TEST_DATA_PATH_W);
	output_dir /= "semantic";
	output_dir /= "detector";
	boost::filesystem::create_directories(output_dir);

	// Regions file
	boost::filesystem::path regions_file = string(TEST_DATA_PATH_R);
	regions_file /= "semantic";
	regions_file /= "3_features";
	regions_file /= "image";
	regions_file /= "mediapro";
	regions_file /= "VTS_01_2";
	regions_file /= "0003";
	regions_file /= "0003105-vd.xml";

    Detector detector(models_file.string(), output_dir.string());

    // Check that detection is not run for semantic classes not in the ontology
    BOOST_CHECK_THROW(detector.detect(regions_file.string(), 2), ImagePlusError);

    // Check normal detection does not throw any exception
    BOOST_CHECK_NO_THROW(detector.detect(regions_file.string(), 1));
}


BOOST_AUTO_TEST_SUITE_END ();

#endif // USE_XML
